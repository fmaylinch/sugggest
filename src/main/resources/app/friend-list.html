<link rel="import" href="components/polymer/polymer.html">
<link rel="import" href="friend-service.html">
<link rel="import" href="friend-card.html">
<link rel="import" href="components/core-icons/core-icons.html">
<link rel="import" href="components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="components/paper-input/paper-input.html">
<link rel="import" href="loading-spinner.html">

<polymer-element name="friend-list" attributes="user">
  <template>
    <style>
    :host {
      display: block;
      width: 100%;
    }
    #emailform {
        display: block;
        position: relative;
        width: 100%;
    }
    friend-card {
      margin-bottom: 30px;
    }

    </style>

      <core-ajax id="ajax"
                 method="POST" url="/api/users/friends"
                 contentType="application/json"
                 on-core-response="{{friendAdded}}"
                 on-core-error="{{addFriendFailed}}"
                 handleAs="json">
      </core-ajax>

      <friend-service id="service" user="{{user}}" friends="{{friends}}" done="{{done}}"></friend-service>

      <div layout vertical center>

          <div id="emailform">
              <div layout horizontal>
                  <paper-input flex label="Email" value="{{email}}"></paper-input>
                  <paper-icon-button icon="add-circle" on-click="{{addFriend}}"></paper-icon-button>
              </div>
          </div>

          <template if="{{done}}">
              <template repeat="{{friend in friends}}">
                  <friend-card user="{{user}}" friend="{{friend}}">
                  </friend-card>
              </template>

              <template if="{{friends.length == 0}}">
                  <p>Tell your friends to sign up and add them here.</p>
              </template>
          </template>

          <template if="{{!done}}">
              <loading-spinner></loading-spinner>
          </template>

      </div>
    
  </template>

  <script>

      Polymer('friend-list', {

          email: "",

          done: false,

          ready: function () {

              var headers = {
                  Authorization: "Basic " + btoa(this.user.email + ":" + this.user.password)
              };

              console.log("user", this.user);
              console.log("header for adding friend", JSON.stringify(headers));

              this.$.ajax.headers = JSON.stringify(headers);
          },

          addFriend: function() {

              var friend = {
                  email: this.email
              };

              console.log("Adding friend: ", friend);

              this.$.ajax.body = JSON.stringify(friend);
              this.$.ajax.go();
          },

          friendAdded: function() {

              var friend = this.$.ajax.response;
              console.log("Friend added", friend);
              this.email = "";
              this.$.service.refresh();

              alert("Friend added: " + friend.name);
              // TODO: display toast or dialog
          },

          addFriendFailed: function(event, detail) {

              // TODO: display toast or dialog
              if (detail.xhr.status == 404) {
                  alert("There's no user with that email. Invite that friend!");
              } else {
                  console.log("Ooops, something went wrong (status: " + detail.xhr.status + "). Please, try again.");
              }
          }
      });

  </script>

</polymer-element>
